<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leftist-Progressive Night Out!</title>
    <style>
      :root{
        --bg: #0b0f17;
        --card: #121826;
        --muted: #8fa3b0;
        --text: #e6eef4;
        --accent: rgb(59, 130, 246);
        --accent-2: rgb(239, 68, 68);
        --danger: #ef4444;
        --ring: rgba(37, 0, 250, 0.35);
        --shadow: 0 10px 25px rgba(0,0,0,.35);
        --radius-lg: 20px;
        --radius-sm: 12px;
      }
      @media (prefers-color-scheme: light){
        :root{ --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#52606d; --shadow:0 10px 25px rgba(2,6,23,.07);}
        body{background:linear-gradient(120deg,#eef2ff 0%, #fdf2f8 100%)}
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
        color:var(--text); background:radial-gradient(1200px 600px at 10% -10%, rgba(59, 130, 246,.25), transparent 40%),
        radial-gradient(1000px 500px at 110% 10%, rgba(239, 68, 68,.22), transparent 40%), var(--bg);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(10px);
        background: color-mix(in oklab, var(--bg), transparent 40%);
        border-bottom: 1px solid color-mix(in oklab, var(--muted), transparent 80%);
        display: flex;
        flex-direction: column;   /* stack title + nav */
      }

      header .wrap.title {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .logo {
        width: 80px;   /* bigger logo */
        height: auto;  /* keeps proportions */
        align-self: stretch;  /* spans height of the flex row */
        object-fit: contain;
      }
      .wrap{max-width:1100px; margin:0 auto; padding: 18px 20px}
      .title{display:flex; gap:14px; align-items:center}
      h1{font-size: clamp(22px, 3.5vw, 34px); margin:0; letter-spacing:.2px}
      main.wrap{padding-top: 28px}

      .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 8px 0 18px}
      .search{flex:1; position:relative}
      .search input{width:100%; background:var(--card); color:var(--text); border:1px solid transparent; padding:12px 14px 12px 40px; border-radius: 12px; outline:none; box-shadow: var(--shadow)}
      .search input:focus{border-color:var(--accent); box-shadow:0 0 0 6px var(--ring)}
      .search svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6}
      .btn{background:var(--accent); color:white; padding:12px 14px; border:none; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); transition:transform .06s ease}
      .btn:active{transform:translateY(1px)}

      .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:18px}
      .card{background:var(--card); border:1px solid color-mix(in oklab, var(--muted), transparent 80%); border-radius:var(--radius-lg); overflow:hidden; box-shadow: var(--shadow); display:flex; flex-direction:column}
      .media{position:relative; aspect-ratio: 16/9; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08));}
      .media img{width:100%; height:100%; object-fit:cover; display:block}
      .datechip{position:absolute; left:12px; bottom:12px; background: color-mix(in oklab, var(--bg), white 10%); border:1px solid color-mix(in oklab, var(--muted), transparent 75%); color:var(--text); padding:6px 10px; border-radius:999px; font-size:12.5px; backdrop-filter: blur(6px)}
      .content{padding:14px 14px 6px}
      .eyebrow{font-size:12px; color:var(--muted); letter-spacing:.25px}
      .name{font-size: clamp(18px, 2.2vw, 22px); margin:6px 0 8px}
      .desc {
        color: var(--muted);
        margin: 0 0 10px;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
        transition: max-height 0.25s ease;
      }
      .desc.expanded { -webkit-line-clamp: unset; overflow: visible; }
      .toggle-desc { background:none; border:none; color:var(--accent); font-size:13px; cursor:pointer; padding:0; margin-top:-6px; margin-bottom:10px; text-align:left;}
      .toggle-desc:hover { color:var(--accent-2);}
      .stats{display:flex; gap:10px; align-items:center; font-size:13.5px; color:var(--muted)}
      .stats strong{color:var(--text)}

      .form{display:flex; gap:8px; padding:12px 14px 16px; align-items:center}
      .form input{flex:1; background: color-mix(in oklab, var(--card), black 8%); color:var(--text); border:1px solid transparent; padding:10px 12px; border-radius:12px; outline:none}
      .form input:focus{border-color:var(--accent); box-shadow:0 0 0 6px var(--ring)}
      .form button{background: var(--accent-2)}

      .skeleton{animation: pulse 1.4s ease-in-out infinite; background: color-mix(in oklab, var(--card), white 4%); border-radius:12px; height:260px}
      @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}

      .empty{color:var(--muted); text-align:center; padding:60px 0}
      .toast{position:fixed; inset: auto 20px 20px auto; background: var(--card); color:var(--text); border:1px solid color-mix(in oklab, var(--muted), transparent 75%); padding:12px 14px; border-radius: 12px; box-shadow: var(--shadow); opacity:0; transform: translateY(10px); pointer-events:none; transition: all .2s ease}
      .toast.show{opacity:1; transform: translateY(0); pointer-events:auto}
      .error{color: var(--danger)}
      footer{color:var(--muted); text-align:center; padding:30px 0 60px}
      a.inline{color:inherit; text-decoration-color: color-mix(in oklab, var(--muted), transparent 45%)}
      .description {
        background: var(--card);
        border: 1px solid color-mix(in oklab, var(--muted), transparent 80%);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        padding: 20px 24px;
        margin: 0 0 24px;
        text-align: center;
      }
      .description h2 { font-size: clamp(20px, 2.5vw, 26px); margin:0 0 10px; color:var(--text);}
      .description p { margin:0 auto; max-width:700px; font-size:15px; line-height:1.6; color:var(--muted);}
      .description a { color:var(--accent); text-decoration-color: color-mix(in oklab, var(--accent), transparent 60%); transition: color 0.2s ease;}
      .description a:hover { color: var(--accent-2);}
      .gradient-text {
        background: linear-gradient(90deg, #ef4444, #ffffff, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
      }
      .names { margin:12px 0 0; padding:10px; background: color-mix(in oklab, var(--card), white 3%); border:1px solid color-mix(in oklab, var(--muted), transparent 70%); border-radius:var(--radius-sm); display:flex; flex-wrap:wrap; gap:6px; box-shadow: inset 0 1px 4px rgba(0,0,0,0.15);}
      .names strong { flex-basis:100%; margin-bottom:4px; font-size:13px; color:var(--muted);}
      .name-badge { color:#fff; padding:4px 10px; border-radius:999px; font-size:13px; font-weight:500; white-space:nowrap; box-shadow:0 2px 6px rgba(0,0,0,0.15); transition: transform 0.15s ease;}
      .name-badge:hover { transform:scale(1.08);}
      .location { font-size:13px; color:var(--muted); margin:2px 0 1px;}
      .gradient-underline { position:relative; color:var(--muted); text-decoration:none;}
      .gradient-underline::after { content:""; position:absolute; left:0; bottom:-2px; width:100%; height:1px; background:linear-gradient(90deg,#ef4444, #ffffff, #3b82f6); border-radius:1px;}

      /* nav with icons */
      .nav-desktop {
        display:flex;
        gap:22px;
        justify-content: center;
      }
      .nav-desktop a {
        display:flex;
        flex-direction:column;
        align-items:center;
        text-decoration:none;
        color:var(--text);
        font-weight:600;
        font-size:15px;
        transition:color 0.2s;
      }
      .nav-desktop a:hover { color:var(--accent-2);}
      .nav-desktop .label { display:inline;}
      .site-header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(10px);
        background: color-mix(in oklab, var(--bg), transparent 40%);
        border-bottom: 1px solid color-mix(in oklab, var(--muted), transparent 80%);
      }

      .header-grid {
        display: grid;
        grid-template-columns: auto 1fr;  /* logo | content */
        grid-template-rows: auto auto;    /* title row, nav row */
        column-gap: 16px;
        row-gap: 8px;
        align-items: center;
      }

      /* Logo spans both rows (title + nav) */
      .header-grid .brand {
        grid-column: 1;
        grid-row: 1 / span 2;
        display: flex;
        align-items: center;
      }

      .header-grid .logo {
        height: 88px;         /* tweak to taste */
        width: auto;
        object-fit: contain;
      }

      /* Title sits to the right, first row */
      .header-grid h1 {
        grid-column: 2;
        grid-row: 1;
        margin: 0;
        font-size: 24px;
      }
      .header-grid .nav-desktop {
        grid-column: 2;
        grid-row: 2;
        display: flex;
        gap: 18px;
        align-items: center;
        padding: 8px 0px;
      }

      .header-grid .nav-desktop a {
        text-decoration: none;
        color: var(--text);
        font-weight: 600;
        font-size: 15px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: color .2s;
      }

      .header-grid .nav-desktop a:hover {
        color: var(--accent-2);
      }

      @media (max-width:1160px){
        .nav-desktop .label { display:none; font-size:16px; margin-bottom:0;}
      }

      @media (max-width:740px){
        .header-grid h1 {font-size: 14px;}
      }

      @media (max-width:640px){
        .nav-desktop { gap:16px;}
        .header-grid .logo { height: 72px; }
        .header-grid .nav-desktop { gap: 14px; padding: 6px 10px; }
        .header-grid .brand { display: none; }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="wrap header-grid">
        <span class="brand label">
          <a href="events.html" aria-label="Home">
            <img src="images/lpno.png" alt="LPNO logo" class="logo" />
          </a>
        </span>
        <h1 class="title">Leftist-Progressive Night Out! - New Jersey Chapter</h1>

        <nav class="nav-desktop">
          <a href="events.html"><span class="label">Events</span></a>
          <a href="join.html"><span class="label">Mailing List</span></a>
          <a href="volunteer.html"><span class="label">Volunteer</span></a>
          <a href="donate.html"><span class="label">Donate</span></a>
          <a href="find.html"><span class="label">Chapters</span></a>
          <a href="about.html"><span class="label">About</span></a>
        </nav>
      </div>
    </header>

    <main class="wrap">
      <!--<section class="description">
        <h2>About Our Club</h2>
        <p>
          Leftist-Progressive Night Out! is a NJ based social club for like-minded people to build strength and power through community during troubled times. We welcome progressives and leftists of every 
          type! Come get to know other progressives! Have fun and relax with other politically and socially progressive people in a variety of different 
          environments! We'll be having pub nights, movie nights, game nights, pizza nights, dinner parties, and anything else that sounds like a fun night. 
          Brainstorm, network, or just enjoy the activities with other people you'll probably like!
        </p>
      </section>-->
      <div class="toolbar">
        <div class="search" role="search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <input id="q" placeholder="Search by name or description…" aria-label="Search events" />
        </div>
        <button id="refresh" class="btn" type="button" title="Refresh">Refresh</button>
      </div>

      <div id="events" class="grid" aria-live="polite" aria-busy="true"></div>
      <p id="msg" class="empty" hidden></p>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <footer>
      <small>© 2025 Leftist-Progressive Night Out!</small>
    </footer>

    <script>
      const API = 'https://lpno.lpno-dev.workers.dev';
      const els = {
        list: document.getElementById('events'),
        search: document.getElementById('q'),
        refresh: document.getElementById('refresh'),
        msg: document.getElementById('msg'),
        toast: document.getElementById('toast')
      };
      const fmtDate = new Intl.DateTimeFormat(navigator.language || 'en-US', { dateStyle: 'medium', timeStyle: 'short' });
      const relTime = new Intl.RelativeTimeFormat(navigator.language || 'en-US', { numeric: 'auto' });

      const escapeHTML = (s='') => s
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'",'&#39;');

      function whenRelative(iso){
        const now = Date.now();
        const t = new Date(iso).getTime();
        const diff = t - now;
        const mins = Math.round(diff/60000);
        if (Math.abs(mins) < 60) return relTime.format(mins, 'minute');
        const hrs = Math.round(mins/60);
        if (Math.abs(hrs) < 24) return relTime.format(hrs, 'hour');
        const days = Math.round(hrs/24);
        return relTime.format(days, 'day');
      }
      function showToast(text, ok=true){
        els.toast.textContent = text;
        els.toast.classList.toggle('error', !ok);
        els.toast.classList.add('show');
        setTimeout(()=> els.toast.classList.remove('show'), 2200);
      }
      function skeleton(n=6){
        els.list.setAttribute('aria-busy','true');
        els.list.innerHTML = Array.from({length:n}).map(()=>`<div class="skeleton"></div>`).join('');
        els.msg.hidden = true;
      }
      function render(events) {
        els.list.removeAttribute('aria-busy');
        if (!Array.isArray(events) || events.length === 0){
          els.list.innerHTML = '';
          els.msg.hidden = false; els.msg.textContent = 'No upcoming events yet.';
          return;
        }
        const q = els.search.value.trim().toLowerCase();
        const filtered = q ? events.filter(e => (e.name+" "+(e.description||'')).toLowerCase().includes(q)) : events;
        if (filtered.length === 0){
          els.list.innerHTML = '';
          els.msg.hidden = false; els.msg.textContent = 'No matches for your search.';
          return;
        } else { els.msg.hidden = true; }
        const frag = document.createDocumentFragment();
        filtered.forEach(ev => {
          const card = document.createElement('article');
          card.className = 'card';
          card.setAttribute('data-id', ev.id);
          card.tabIndex = 0;
          const hasImg = !!ev.image_url;
          const media = document.createElement('div');
          media.className = 'media';
          if (hasImg){
            const img = document.createElement('img');
            img.src = ev.image_url; img.alt = `${ev.name} banner`; img.loading = 'lazy'; img.decoding = 'async';
            media.appendChild(img);
          }
          const chip = document.createElement('div');
          chip.className = 'datechip';
          chip.textContent = whenRelative(ev.time);
          media.appendChild(chip);
          card.appendChild(media);
          const content = document.createElement('div');
          content.className = 'content';
          const mapUrl = `https://www.google.com/maps/search/?api=1&query=${ev.lat},${ev.lon}`;
          content.innerHTML = `
            <div class="eyebrow">${fmtDate.format(new Date(ev.time))}</div>
              <div class="location">
                <a class="gradient-underline" href="${mapUrl}" target="_blank" rel="noopener">
                  ${escapeHTML(ev.location_name || 'Location TBD')}
                </a>
              </div>
              <div class="location">
                <a class="gradient-underline" href="${mapUrl}" target="_blank" rel="noopener">
                  ${escapeHTML(ev.location_city || 'Location TBD')}
                </a>
              </div>
            <h2 class="name">${escapeHTML(ev.name || 'Untitled')}</h2>
            <p class="desc">${escapeHTML(ev.description || 'No description yet.')}</p>
            ${
              ev.description && ev.description.length > 180
                ? `<button class="toggle-desc">Read more</button>`
                : ''
            }
            <div class="stats" aria-label="RSVP counts">
              <span><strong>${Number(ev.total_rsvps||0).toLocaleString()}</strong> RSVPs</span>
              <span>• Meetup: ${Number(ev.meetup_rsvps||0).toLocaleString()}</span>
              <span>• Site: ${Number(ev.local_rsvps||0).toLocaleString()}</span>
            </div>
            ${
              ev.all_names?.length
                ? `<div class="names">
                    <strong>Who’s coming:</strong>
                    ${ev.all_names.map((n, i) => {
                      const colors = ['#ef4444', '#fff', '#3b82f6'];
                      const color = colors[i % colors.length];
                      return `<span class="name-badge" style="background:${color}; color:${color === '#fff' ? '#000' : '#fff'}">${escapeHTML(n)}</span>`;
                    }).join('')}
                  </div>`
                : ''
            }
          `;
          card.appendChild(content);
          const form = document.createElement('form');
          form.className = 'form';
          form.innerHTML = `
            <input name="name" placeholder="Your name" aria-label="Your name" required />
            <button class="btn">RSVP</button>
          `;
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = form.name.value.trim();
            if (!name) return;
            const payload = { event_id: ev.id, name };
            form.querySelector('button').disabled = true;
            try{
              const res = await fetch(`${API}/rsvp`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
              if (!res.ok) throw new Error(`RSVP failed (${res.status})`);
              showToast('RSVP saved!');
              await load();
            }catch(err){
              console.error(err);
              showToast('Could not save RSVP.', false);
            }finally{
              form.reset();
              form.querySelector('button').disabled = false;
            }
          });
          card.appendChild(form);
          frag.appendChild(card);
        });
        els.list.innerHTML = '';
        els.list.appendChild(frag);
        document.querySelectorAll('.toggle-desc').forEach(btn => {
          btn.addEventListener('click', () => {
            const desc = btn.previousElementSibling;
            desc.classList.toggle('expanded');
            btn.textContent = desc.classList.contains('expanded') ? 'Show less' : 'Read more';
          });
        });
        const obs = new IntersectionObserver(entries=>{
          entries.forEach(en=>{
            if (en.isIntersecting){
              en.target.animate([
                {transform:'translateY(8px)', opacity:.001},
                {transform:'translateY(0)', opacity:1}
              ], {duration:260, easing:'cubic-bezier(.2,.8,.2,1)'});
              obs.unobserve(en.target);
            }
          });
        },{rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.card').forEach(el=>obs.observe(el));
      }
      async function load(){
        skeleton();
        try{
          const res = await fetch(`${API}/events`, { headers:{'Accept':'application/json'} });
          const events = await res.json();
          if (!Array.isArray(events)) throw new Error(events && (events.error || JSON.stringify(events)) || 'Invalid response');
          events.sort((a,b)=> new Date(a.time) - new Date(b.time));
          render(events);
        }catch(err){
          console.error(err);
          els.list.innerHTML = '';
          els.msg.hidden = false;
          els.msg.innerHTML = `<span class="error">Error loading events.</span> <small>${escapeHTML(String(err.message||err))}</small>`
        }
      }
      els.refresh.addEventListener('click', load);
      load();
    </script>
  </body>
</html>
